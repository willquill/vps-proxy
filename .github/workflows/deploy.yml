name: Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Ansible version to use"
        required: false
        default: "12.1.0"
        type: string
  workflow_run:
    workflows: ["Security"]
    branches: [main]
    types:
      - completed

jobs:
  ansible-deploy:
    name: Ansible Playbook Run
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main') }}
    environment: hetzner-cloud
    # Note: We do not need to set each env because instead of envvars,
    #       we set -e options where necessary
    env:
      ANSIBLE_VERSION: ${{ github.event.inputs.version || '12.1.0' }}
      ANSIBLE_HOST_KEY_CHECKING: False
      ANSIBLE_FORCE_COLOR: 1
      github_ref_name: ${{ github.head_ref || github.ref_name }}

    steps:
      # ---------- Checkout code ----------
      - name: Checkout repo
        uses: actions/checkout@v5

      # ---------- Setup tooling ----------
      - name: "Install Python"
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: "Cache python packages"
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-${{ env.ANSIBLE_VERSION }}

      - name: "Install packages"
        shell: bash
        run: |
          python -m pip install ansible==${{ env.ANSIBLE_VERSION }}
      - name: "Print Ansible version"
        run: ansible-playbook --version

      # ---------- Install Ansible Galaxy requirements ----------
      - name: Install Ansible Galaxy requirements
        run: |
          ansible-galaxy collection install -r ansible/galaxy-requirements.yml

      # ---------- Wait for cloud-init ----------
      - name: Wait for cloud-init to complete
        run: |
          echo "Waiting for cloud-init to complete on ${{ secrets.SERVER_IPV4 }}..."
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PROXY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          for i in {1..30}; do
            echo "Attempt $i/30: Checking if SSH is available and cloud-init is done..."
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p 2222 -i ~/.ssh/id_ed25519 ${{ github.repository_owner }}@${{ secrets.SERVER_IPV4 }} "cloud-init status --wait" 2>/dev/null; then
              echo "Cloud-init completed successfully!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for cloud-init to complete"
              exit 1
            fi
            echo "Not ready yet, waiting 10 seconds..."
            sleep 10
          done

      # ---------- SSH key ----------
      # Use IPv4 from Terraform output
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PROXY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p 2222 -H ${{ secrets.SERVER_IPV4 }} >> ~/.ssh/known_hosts

      # ---------- Create inventory file ----------
      - name: Create inventory file
        run: |
          cat <<EOF > inventory
          [vps]
            ${{ secrets.SERVER_IPV4 }} ansible_user=${{ github.repository_owner }} ansible_port=2222
          EOF

      # ---------- Run Ansible ----------
      - name: Run ansible playbook
        # Only run if every previous step succeeded
        if: ${{ success() }}
        run: |
          ansible-playbook \
            -i inventory \
            -e "ansible_ssh_private_key_file=~/.ssh/id_ed25519" \
            -e "repo_dest=/home/${{ github.repository_owner }}/vps-proxy" \
            -e "vps_host=${{ secrets.SERVER_IPV4 }}" \
            -e "user_name=${{ github.repository_owner }}" \
            -e "github_ref_name=${{ env.github_ref_name }}" \
            -e "wireguard_port=51820" \
            -e "wireguard_tunnel_subnet=192.168.145.0/24" \
            -e "wireguard_address=192.168.145.1/24" \
            -e "wireguard_address_host=192.168.145.1/32" \
            -e "wireguard_peer1=192.168.145.2/32" \
            -e "wireguard_peer1_subnet=10.1.0.0/16" \
            -e "wireguard_peer_endpoint=${{ secrets.WIREGUARD_PEER_ENDPOINT }}" \
            -e "wireguard_peer_port=51821" \
            -e "traefik_username=${{ secrets.TRAEFIK_BASIC_AUTH_USERNAME }}" \
            -e "traefik_password=${{ secrets.TRAEFIK_BASIC_AUTH_PASSWORD }}" \
            -e "traefik_oidc_auth_secret=${{ secrets.TRAEFIK_OIDC_AUTH_SECRET }}" \
            -e "traefik_oidc_client_id=${{ secrets.TRAEFIK_OIDC_CLIENT_ID }}" \
            -e "traefik_oidc_client_secret=${{ secrets.TRAEFIK_OIDC_CLIENT_SECRET }}" \
            -e "idm_domain=${{ secrets.IDM_DOMAIN }}" \
            -e "lan_service1=${{ secrets.LAN_SERVICE1 }}" \
            -e "lan_service2=${{ secrets.LAN_SERVICE2 }}" \
            -e "maxmind_license_key=${{ secrets.MAXMIND_LICENSE_KEY }}" \
            -e "pocketid_postgres_user=${{ secrets.POCKETID_POSTGRES_USER }}" \
            -e "pocketid_postgres_password=${{ secrets.POCKETID_POSTGRES_PASSWORD }}" \
            -e "pocketid_postgres_db=${{ secrets.POCKETID_POSTGRES_DB }}" \
            -e "pocketid_encryption_key=${{ secrets.POCKETID_ENCRYPTION_KEY }}" \
            -e "smtp_host=${{ secrets.SMTP_HOST }}" \
            -e "smtp_user=${{ secrets.SMTP_USER }}" \
            -e "smtp_password=${{ secrets.SMTP_PASSWORD }}" \
            -e "smtp_to=${{ secrets.SMTP_TO }}" \
            -e "acme_email=${{ secrets.ACME_EMAIL }}" \
            -e "public_hostname=${{ secrets.PUBLIC_DOMAIN }}" \
            -e "cf_dns_api_token=${{ secrets.CF_DNS_API_TOKEN }}" \
            -e "cf_zone_api_token=${{ secrets.CF_ZONE_API_TOKEN }}" \
            -e "timezone=${{ secrets.TZ }}" \
            -e 'nfs_mounts=${{ secrets.NFS_MOUNTS }}' \
            -e "restore_databases=${{ secrets.RESTORE_DATABASES }}" \
            ansible/main.yml --tags update,ufw,wireguard,docker,mounts,traefik,restore,deploy
