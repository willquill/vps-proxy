name: Tofu Apply

on:
  workflow_dispatch:
    inputs:
      tofu_version:
        description: "OpenTofu version to use"
        required: false
        default: "~>1.10.7"
        type: string

jobs:
  tofu-apply:
    name: Apply Infrastructure Changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - tofu_version: ${{ github.event.inputs.tofu_version || '~>1.10.7' }}
            working_dir: opentofu
    environment: hetzner-cloud
    env:
      TZ: ${{ secrets.TZ }}
      # AWS keys for S3 state backend
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      # To populate Terraform variables
      TF_VAR_repo_owner: ${{ github.repository_owner }}
      TF_VAR_workflow_actor: ${{ github.actor }}
      TF_VAR_ssh_authorized_key: ${{ secrets.VPS_PROXY_KEY_PUBLIC }}
      # Hetzner Cloud token required to create resources
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      tf_actions_working_dir: ${{ matrix.working_dir }}
      tofu_version: ${{ matrix.tofu_version }}
      github_ref_name: ${{ github.head_ref || github.ref_name }}

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.tofu_version }}-${{ matrix.working_dir }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v5

      - name: Apply
        id: apply
        uses: ./.github/actions/opentofu
        with:
          github_ref_name: ${{ env.github_ref_name }}
          tofu_version: ${{ matrix.tofu_version }}
          apply: "true"

      - name: Save SERVER_IPV4 to GitHub environment variable
        run: |
          SERVER_IPV4=$(jq -r '.server_ipv4.value' ${{ env.tf_actions_working_dir }}/tf_output.json)
          echo "SERVER_IPV4=$SERVER_IPV4" >> $GITHUB_ENV
          echo "Saved SERVER_IPV4: $SERVER_IPV4"
          gh variable set SERVER_IPV4 --body "$SERVER_IPV4" --env hetzner-cloud
          echo "âœ“ SERVER_IPV4 saved to hetzner-cloud environment"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
