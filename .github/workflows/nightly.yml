name: Nightly

on:
  # Allows manual triggering
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *" # 6 AM every day

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITLEAKS_NOTIFY_USER_LIST: ${{ github.repository_owner }}

jobs:
  # FIXME: Duplicated in Lint & Plan, turn into Workflow
  security-git-leaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          # This provides full history for accurate scanning
          fetch-depth: 0
      - uses: ./.github/actions/security
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          gitleaks_notify_user_list: ${{ github.repository_owner }}

  security-tfsec:
    name: Tfsec Scan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - working_dir: opentofu
          - working_dir: tfstate

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.working_dir }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v5

      - uses: ./.github/actions/security
        with:
          working_dir: ${{ matrix.working_dir }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          gitleaks_notify_user_list: ${{ github.repository_owner }}
