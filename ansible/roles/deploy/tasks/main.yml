---
- name: Enable SSH TCP forwarding for VS Code Remote SSH
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config.d/99-ssh-hardening.conf
    regexp: "^AllowTcpForwarding"
    line: "AllowTcpForwarding yes"
    state: present
  become: true
  notify: Restart sshd

- name: Ensure application directory exists with correct ownership
  ansible.builtin.file:
    path: "{{ repo_dest }}"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0755"

# On each run of this task, create a timestamped backup
# of the files about to be overwritten.
- name: Create backups directory
  ansible.builtin.file:
    path: "{{ repo_dest }}/backups"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0755"

- name: Backup current docker-compose.yml
  ansible.builtin.copy:
    src: "{{ repo_dest }}/{{ item.src }}"
    dest: "{{ repo_dest }}/backups/{{ item.dest }}-{{ ansible_date_time.iso8601_basic_short }}-{{ github_ref_name | default('unknown') }}.yml"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"
    remote_src: true
  with_items:
    - { src: "docker-compose.yml", dest: "docker-compose" }
    - { src: "config/gatus/config.yml", dest: "gatus" }
  register: deploy_backup_result
  failed_when: false

- name: Copy docker-compose.yml to VPS
  ansible.builtin.copy:
    src: docker-compose.yml
    dest: "{{ repo_dest }}/docker-compose.yml"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"

- name: Create .env file from template
  ansible.builtin.template:
    src: env.j2
    dest: "{{ repo_dest }}/.env"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0600"
  no_log: true

- name: Create application configuration directories
  ansible.builtin.file:
    path: "{{ repo_dest }}/config/{{ item }}"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0755"
  with_items:
    - "gatus"
    - "gatus_postgres"
    - "pocketid_postgres"
    - "pocketid"
  when: not (vps_proxy_restored | default(false))

- name: Copy Gatus configuration
  ansible.builtin.copy:
    src: gatus/config.yml
    dest: "{{ repo_dest }}/config/gatus/config.yml"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"

- name: Check if Gatus backup exists
  ansible.builtin.stat:
    path: /mnt/backup/gatus_postgres
  register: gatus_backup_stat
  when:
    - nfs_server is defined
    - restore_databases | default(false) | bool
    - not (vps_proxy_restored | default(false))

- name: Check if Pocket ID backup exists
  ansible.builtin.stat:
    path: /mnt/backup/pocketid_postgres
  register: pocketid_backup_stat
  when:
    - nfs_server is defined
    - restore_databases | default(false) | bool
    - not (vps_proxy_restored | default(false))

- name: Restore Gatus database from backup
  ansible.builtin.copy:
    src: /mnt/backup/gatus_postgres/
    dest: "{{ repo_dest }}/config/gatus_postgres/"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: preserve
    remote_src: true
  when:
    - nfs_server is defined
    - restore_databases | default(false) | bool
    - not (vps_proxy_restored | default(false))
    - gatus_backup_stat.stat.exists | default(false)
  register: gatus_restore
  failed_when: false

- name: Restore Pocket ID database from backup
  ansible.builtin.copy:
    src: /mnt/backup/pocketid_postgres/
    dest: "{{ repo_dest }}/config/pocketid_postgres/"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: preserve
    remote_src: true
  when:
    - nfs_server is defined
    - restore_databases | default(false) | bool
    - not (vps_proxy_restored | default(false))
    - pocketid_backup_stat.stat.exists | default(false)
  register: pocketid_restore
  failed_when: false

- name: Check if update.sh script exists
  ansible.builtin.stat:
    path: "{{ repo_dest }}/update.sh"
  register: deploy_update_sh_stat

# Create executable update.sh in repo_dest
- name: Create update.sh script
  ansible.builtin.copy:
    dest: "{{ repo_dest }}/update.sh"
    content: |
      #!/bin/bash
      docker compose pull
      docker compose up -d
      docker image prune -f
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0755"
  when: not deploy_update_sh_stat.stat.exists

# Execute docker compose update script
- name: Execute update.sh script
  ansible.builtin.command: "./update.sh"
  args:
    chdir: "{{ repo_dest }}"
  become: true
  become_user: "{{ user_name }}"
  when: not ansible_check_mode
