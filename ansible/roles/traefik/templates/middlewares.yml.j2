########################
### HTTP Middlewares ###
########################
http:
  middlewares:

    rate-limit-strict:
      average: 10      # 10 requests
      period: 1m       # per minute
      burst: 20        # allow burst of 20

    rate-limit-moderate:
      average: 100
      period: 1m
      burst: 200

    rate-limit-lenient:
      average: 500
      period: 1m
      burst: 1000    
    
    https-redirectscheme:
      redirectScheme:
        scheme: https
        permanent: true

    default-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        frameDeny: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 15552000
        customFrameOptionsValue: SAMEORIGIN
        customRequestHeaders:
          X-Forwarded-Proto: https

    # Shouldn't need X-Forwarded-* b/c Traefik forwards by default
    # Comment: https://community.traefik.io/t/x-forwarded-for-missing/15013/2
    # The code: https://github.com/traefik/traefik/blob/master/pkg/middlewares/forwardedheaders/forwarded_header.go
    # youtrack-headers:
    #   headers:
    #     browserXssFilter: true
    #     contentTypeNosniff: true
    #     frameDeny: true
    #     forceSTSHeader: true
    #     stsIncludeSubdomains: true
    #     stsPreload: true
    #     stsSeconds: 15552000
    #     customFrameOptionsValue: SAMEORIGIN
    #     customRequestHeaders:
    #       X-Forwarded-Proto: https   
    #       X-Forwarded-Host: "youtrack.{{ public_hostname }}"       

    {# authelia:
      forwardAuth:
        #address: 'https://authelia.{{ public_hostname }}/api/authz/forward-auth'
        address: 'http://authelia:9091/api/verify?rd=https://authelia.{{ public_hostname }}'
        trustForwardHeader: 'true'
        authResponseHeaders:
          - Remote-User
          - Remote-Groups
          - Remote-Name
          - Remote-Email #}

    oidc-auth:
      plugin:
        traefik-oidc-auth:
          Secret: {{ traefik_oidc_auth_secret }} # Please change this secret for your setup
          Provider:
            Url: "https://auth.{{ public_hostname }}/"
            ClientId: {{ traefik_oidc_client_id }}
            ClientSecret: {{ traefik_oidc_client_secret }}
            UsePkce: true
          Scopes: ["openid", "profile", "email"]

    public:
      chain:
        middlewares:
        - default-headers
        - rate-limit-moderate

    public-oidc-auth:
      chain:
        middlewares:
        - default-headers
        - rate-limit-moderate
        - oidc-auth

    http-RFC1918-only:
      ipAllowList:
        sourceRange:
          - "10.0.0.0/8"
          - "192.168.0.0/16"
          - "172.16.0.0/12"
    
    private:
      chain:
        middlewares:
        - http-RFC1918-only
        - default-headers
