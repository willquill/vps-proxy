---
- name: Ensure logs directory exists
  ansible.builtin.file:
    path: "{{ repo_dest }}/logs"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0755"

- name: Ensure Traefik config directory exists
  ansible.builtin.file:
    path: "{{ repo_dest }}/config/traefik/config"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0755"

- name: Create traefik backups directory
  ansible.builtin.file:
    path: "{{ repo_dest }}/backups"
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0755"

- name: Backup current Traefik configuration files
  ansible.builtin.copy:
    src: "{{ repo_dest }}/{{ item.src }}"
    dest: "{{ repo_dest }}/backups/{{ item.dest }}-{{ ansible_date_time.iso8601_basic_short }}-{{ github_ref_name | default('unknown') }}.yml"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"
    remote_src: true
  with_items:
    - { src: "config/traefik/traefik.yml", dest: "traefik" }
    - { src: "config/traefik/config/middlewares.yml", dest: "middlewares" }
    - { src: "config/traefik/config/services.yml", dest: "services" }
  register: traefik_backup_result
  failed_when: false

- name: Clean up old backups (keep latest 5 for each file)
  ansible.builtin.shell: |
    set -o pipefail
    for prefix in traefik middlewares services; do
      ls -t {{ repo_dest }}/backups/${prefix}-*.yml 2>/dev/null | tail -n +6 | xargs -r rm -f
    done
  args:
    executable: /bin/bash
  changed_when: false
  failed_when: false

- name: Copy Traefik main configuration
  ansible.builtin.copy:
    src: traefik.yml
    dest: "{{ repo_dest }}/config/traefik/traefik.yml"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"

- name: Copy Traefik middlewares configuration
  ansible.builtin.copy:
    src: middlewares.yml
    dest: "{{ repo_dest }}/config/traefik/config/middlewares.yml"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"

- name: Copy Traefik services configuration
  ansible.builtin.copy:
    src: services.yml
    dest: "{{ repo_dest }}/config/traefik/config/services.yml"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"

- name: Install Apache utils (for htpasswd)
  ansible.builtin.apt:
    name: apache2-utils
    state: present

- name: Generate bcrypt htpasswd line
  ansible.builtin.command: |
    htpasswd -nbB {{ traefik_username }} {{ traefik_password }}
  register: traefik_htpasswd_line
  changed_when: false
  no_log: true

- name: Write htpasswd file
  ansible.builtin.copy:
    content: "{{ traefik_htpasswd_line.stdout }}"
    dest: "{{ repo_dest }}/config/traefik/usersfile.txt"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0600"
  no_log: true

- name: Write CrowdSec API key file
  ansible.builtin.copy:
    content: "{{ crowdsec_traefik_bouncer_api_key }}"
    dest: "{{ repo_dest }}/config/traefik/crowdsec-api-key.txt"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0600"
  no_log: true

- name: Create empty acme.json file if it doesn't exist
  ansible.builtin.file:
    path: "{{ repo_dest }}/config/traefik/acme.json"
    state: touch
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0600"
    modification_time: preserve
    access_time: preserve
  changed_when: false

- name: Create docker proxy network if it doesn't exist
  ansible.builtin.command: docker network create proxy
  register: traefik_create_network_result
  failed_when:
    - traefik_create_network_result.rc != 0
    - "'already exists' not in traefik_create_network_result.stderr"
