---
- name: Install NFS client packages
  ansible.builtin.apt:
    name:
      - nfs-common
    state: present
    update_cache: true

- name: Parse NFS mounts JSON
  ansible.builtin.set_fact:
    mounts_parsed: "{{ (nfs_mounts | string | from_json) if (nfs_mounts | default('') | string != '') else [] }}"
  when: nfs_mounts is defined

- name: Check NFS server accessibility
  ansible.builtin.wait_for:
    host: "{{ item.src.split(':')[0] }}"
    port: 2049
    timeout: 5
    state: started
  with_items: "{{ mounts_parsed | default([]) }}"
  when:
    - mounts_parsed is defined
    - mounts_parsed | length > 0
  register: mounts_nfs_server_check
  ignore_errors: true

- name: Create NFS mount points
  ansible.builtin.file:
    path: "{{ item.item.path }}"
    state: directory
    mode: "0755"
  with_items: "{{ mounts_nfs_server_check.results }}"
  when:
    - mounts_nfs_server_check is defined
    - mounts_nfs_server_check.results is defined
    - item.state is defined
    - item.failed is false

- name: Mount NFS shares
  ansible.posix.mount:
    src: "{{ item.item.src }}"
    path: "{{ item.item.path }}"
    fstype: nfs
    opts: "{{ item.item.opts | default(nfs_default_opts | join(',')) }}"
    state: mounted
  with_items: "{{ mounts_nfs_server_check.results }}"
  when:
    - mounts_nfs_server_check is defined
    - mounts_nfs_server_check.results is defined
    - item.state is defined
    - item.failed is false
  register: mounts_nfs_mount_result
  vars:
    nfs_default_opts:
      - nfsvers=4.2 # Use NFSv4.2 (most secure, best performance)
      - rw # Read-write access
      - nofail # Don't prevent boot if mount fails
      - noatime # Don't update access times (performance)
      - intr # Allow interrupting hung operations
      - tcp # Use TCP for reliability over WAN
      - actimeo=1800 # Cache attributes for 30 minutes
      - soft # Return errors vs hanging on network issues
      - timeo=30 # 3 second timeout for network latency
      - retrans=3 # Retry failed requests 3 times

- name: Set fact for backup mount availability
  ansible.builtin.set_fact:
    mounts_backup_mount_available: "{{ mounts_nfs_mount_result.results | selectattr('item.item.path', 'equalto', '/mnt/backups') | selectattr('failed', 'equalto', false) | list | length > 0 }}"
  when:
    - mounts_nfs_mount_result is defined
    - mounts_nfs_mount_result.results is defined

- name: Install backup script
  ansible.builtin.template:
    src: backup-vps-proxy.sh.j2
    dest: /usr/local/bin/backup-vps-proxy.sh
    owner: root
    group: root
    mode: "0755"
  vars:
    backup_exclude_paths:
      - 'logs/'
      - 'config/crowdsec/'
  when:
    - mounts_backup_mount_available | default(false)

- name: Install systemd email notification script
  ansible.builtin.template:
    src: systemd-email.sh.j2
    dest: /usr/local/bin/systemd-email.sh
    owner: root
    group: root
    mode: "0755"
  when:
    - mounts_backup_mount_available | default(false)
  no_log: true

- name: Install systemd email notification service
  ansible.builtin.template:
    src: status-email@.service.j2
    dest: /etc/systemd/system/status-email@.service
    owner: root
    group: root
    mode: "0644"
  when:
    - mounts_backup_mount_available | default(false)

- name: Install backup systemd service
  ansible.builtin.template:
    src: backup-vps-proxy.service.j2
    dest: /etc/systemd/system/backup-vps-proxy.service
    owner: root
    group: root
    mode: "0644"
  when:
    - mounts_backup_mount_available | default(false)
  notify: Reload systemd

- name: Install backup systemd timer
  ansible.builtin.template:
    src: backup-vps-proxy.timer.j2
    dest: /etc/systemd/system/backup-vps-proxy.timer
    owner: root
    group: root
    mode: "0644"
  when:
    - mounts_backup_mount_available | default(false)
  notify: Reload systemd

- name: Enable and start backup timer
  ansible.builtin.systemd:
    name: backup-vps-proxy.timer
    enabled: true
    state: started
    daemon_reload: true
  when:
    - mounts_backup_mount_available | default(false)
