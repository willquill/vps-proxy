#!/bin/bash
set -euo pipefail

# Backup configuration
SOURCE_DIR="{{ repo_dest }}"
BACKUP_BASE="/mnt/backups/vps-proxy"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="${BACKUP_BASE}/${TIMESTAMP}"
LATEST_LINK="${BACKUP_BASE}/latest"
KEEP_DAYS=14

# Verify NFS mount is available
if ! mountpoint -q /mnt/backups; then
    echo "ERROR: /mnt/backups is not mounted"
    exit 1
fi

# Create backup base directory if it doesn't exist
mkdir -p "$BACKUP_BASE"

# Perform backup with rsync
echo "Starting backup of $SOURCE_DIR to $BACKUP_DIR"
rsync -av --delete \
    --link-dest="${LATEST_LINK}" \
    --exclude='*.log' \
    --exclude='*.sock' \
    --exclude='lost+found' \
{% for path in backup_exclude_paths | default([]) %}
    --exclude='{{ path }}' \
{% endfor %}
    "$SOURCE_DIR/" \
    "$BACKUP_DIR/"

# Update latest symlink
ln -snf "$BACKUP_DIR" "$LATEST_LINK"

# Clean up backups older than KEEP_DAYS
echo "Cleaning up backups older than $KEEP_DAYS days"
find "$BACKUP_BASE" -maxdepth 1 -type d -name "2*" -mtime +$KEEP_DAYS -exec rm -rf {} \;

echo "Backup completed successfully: $BACKUP_DIR"
echo "Kept backups from last $KEEP_DAYS days"
